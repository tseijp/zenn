---
title: "Hono ðŸ”¥ WakuWaku AWS deploy"
emoji: "ðŸ”¥"
type: "tech"
topics:
  - "aws"
  - "lambda"
  - "amplify"
  - "hono"
  - "waku"
published: true
published_at: "2024-12-10 23:52"
---

https://github.com/tseijp/waku-amplify-with-lambda-test
https://tsei.jp/articles/2024/12/10/note/
â†‘english ver

ã“ã®è¨˜äº‹ã¯[Hono Advent Calendar 2024](https://qiita.com/advent-calendar/2024/hono)ã®10æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚ï¼ˆæŠ•ç¨¿ãŒãŽã‚ŠãŽã‚Šã™ãŽã¦ã¸ã‚“ãªã‚¿ã‚¤ãƒˆãƒ«ã«ãªã£ã¡ã‚ƒã£ãŸã‹ã‚‚ã§ã™ðŸ˜­ï¼‰
ã“ã®è¨˜äº‹ã§ã¯Honoã‚’ãƒ™ãƒ¼ã‚¹ã«Reactã®minimumãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€Œ[Waku](https://github.com/dai-shi/waku)ã€ã‚’AWS Amplifyä¸Šã«æ§‹ç¯‰ã—ã¾ã™ã€‚Wakuã¯Next.jsã®ã‚ˆã†ãªReactã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®æœ€æ–°æ©Ÿèƒ½ã‚’Honoã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ã—ã¦å®Ÿç¾ã§ãã¾ã™ã€‚
æœ€å¾Œã«ã€Honoã‚’é€šã˜ã¦AWS Amplifyã‹ã‚‰VPCå†…ã®AWSãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã™ã€‚

AWS Amplify Hostingã®[ãƒ‡ãƒ—ãƒ­ã‚¤ä»•æ§˜](https://docs.aws.amazon.com/en_us/amplify/latest/userguide/ssr-deployment-specification.html)ã«ã‚ˆã‚Šã€Expressã‚„Honoãªã©ã€Next.jsä»¥å¤–ã®ã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚
Amplifyã¯Next.jsã‚„Nuxt.jsã‚’è‡ªå‹•çš„ã«æ¤œå‡ºã—ã€ã„ã„ã‹ã‚“ã˜ã«è¨­å®šã—ã¦ãã‚Œã¾ã™ãŒã€ä»–ã®ã‚µãƒ¼ãƒãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯AWS Amplifyã®ãƒ‡ãƒ—ãƒ­ã‚¤ä»•æ§˜ã«å¾“ã£ã¦ãƒ“ãƒ«ãƒ‰å¾Œã«èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

> ![deploy](https://r.tsei.jp/note/2024-12-10/deploy.mp4.gif)

https://docs.amplify.aws/nextjs/start/quickstart/nextjs-app-router-client-components/

## 1. Deploying Waku with Hono on AWS Amplify

`npm create waku@latest`ã‚³ãƒžãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹å§‹ã—ã€æ¬¡ã®3ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€AWS Amplifyã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
AWS Amplifyã¯ã€Lambdaå†…ã§[aws-lambda-web-adapter](https://github.com/awslabs/aws-lambda-web-adapter)ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’ãŠãã‚‰ãä½¿ç”¨ã—ã¦ãŠã‚Šã€Honoã®HTTPã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨Lambdaã®ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã®é–“ã®ã‚®ãƒ£ãƒƒãƒ—ã‚’åŸ‹ã‚ã‚‹ã“ã¨ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ãªnodeã‚³ãƒžãƒ³ãƒ‰ã§å‹•ãHonoã‚’AWS Lambdaã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### 1.1. Create startServer.mjs

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯AWS Amplifyã®AWS Lambda@Edgeç’°å¢ƒã§`node startServer.mjs`ã‚³ãƒžãƒ³ãƒ‰ã«ã‚ˆã£ã¦ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚
Wakuã«ã‚ˆã£ã¦ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸdist/entries.jsã®ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’HonoãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚

> ```typescript
> // startServer.mjs
> import { Hono } from "hono";
> import { serve } from "@hono/node-server";
> import { serveStatic } from "@hono/node-server/serve-static";
> import { serverEngine } from "waku/unstable_hono";
> 
> const app = new Hono();
> 
> app.use(serveStatic({ root: "./public" }));
> 
> app.use(
>   serverEngine({
>     cmd: "start",
>     loadEntries: () => import("./entries.js"),
>     env: process.env,
>   })
> );
> 
> app.notFound((c) => c.text("404 Not Found", 404));
> 
> console.log(`ready: Listening on http://localhost:3000/`);
> 
> serve({ ...app, port: 3000 });
> ```

### 1.2. Create `amplify.yml`

AWS Lambdaã§ã‚µãƒ¼ãƒãƒ¼ã‚’å‹•ã‹ã™ãŸã‚ã€AWS Amplifyã®CI/CDã§ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’èª¿æ•´ã—ã¾ã™ã€‚
Wakuã®ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’.amplify-hosting/compute/defaultã«ç§»å‹•ã™ã‚‹ã‚³ãƒžãƒ³ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

> ```typescript
> version: 1
> frontend:
>   phases:
>     preBuild:
>       commands:
>         - npm ci --cache .npm --prefer-offline
>         - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
>     build:
>       commands:
>         - npm run build
>     postBuild:
>       commands:
>         - npm prune --production
>         - rm -rf ./.amplify-hosting
>         - mkdir -p ./.amplify-hosting/compute
>         - cp -r ./dist ./.amplify-hosting/compute/default
>         - cp -r ./node_modules ./.amplify-hosting/compute/default/node_modules
>         - cp -r ./dist/public ./.amplify-hosting/static
>         - cp -r ./dist/public ./.amplify-hosting/compute/default
>         - cp deploy-manifest.json ./.amplify-hosting/deploy-manifest.json
>         - cp startServer.mjs ./.amplify-hosting/compute/default/startServer.mjs
>         - 'echo "{ \"type\": \"module\" }" > ./.amplify-hosting/compute/default/package.json'
>   artifacts:
>     baseDirectory: .amplify-hosting
>     files:
>       - '**/*'
> ```

### 1.3. Create `deploy-manifest.json`

.amplify-hosting/compute/defaultå†…ã®ã‚³ãƒ¼ãƒ‰ã‚’å‹•ã‹ã™ãŸã‚ã®AWS Amplifyã‚¹ã‚¿ãƒƒã‚¯ã‚’è¨­å®šã—ã¾ã™ã€‚
computeResourcesã®entrypointã‚’å¤‰æ›´ã—ã¦nodeã«ã‚ˆã£ã¦startServer.mjsãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ï¼ˆãã®ä»–ã¯[å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://www.youtube.com/watch?v=iOlIrU3bhSE)é€šã‚Šã§ã™ï¼‰

> ```json
> {
>   "version": 1,
>   "framework": { "name": "waku", "version": "0.21.7" },
>   "imageSettings": {},
>   "routes": [
>     {
>       "path": "/_amplify/image",
>       "target": {
>         "kind": "ImageOptimization",
>         "cacheControl": "public, max-age=3600, immutable"
>       }
>     },
>     {
>       "path": "/*.*",
>       "target": {
>         "kind": "Static",
>         "cacheControl": "public, max-age=2"
>       },
>       "fallback": {
>         "kind": "Compute",
>         "src": "default"
>       }
>     },
>     {
>       "path": "/*",
>       "target": {
>         "kind": "Compute",
>         "src": "default"
>       }
>     }
>   ],
>   "computeResources": [
>     {
>       "name": "default",
>       "runtime": "nodejs18.x",
>       "entrypoint": "startServer.mjs"
>     }
>   ]
> }
> ```

è¨­å®šã‚’GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã€AWS Amplifyã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰Githubã¨CI/CDã‚’æŽ¥ç¶šã™ã‚‹ã ã‘ã§ã€Honoã‚„Wakuãªã©ã®Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ ðŸš€

## 2. Deploying Hono in AWS VPC using AWS CDK

AWS Amplify Backend ã¯CI/CDã‚’é€šã˜ã¦CloudFrontã€CloudWatchã€Lambdaã€S3ãªã©ã®æ§‹ç¯‰ã‚’è‡ªå‹•åŒ–ã—ã¦ãã‚Œã¾ã™ãŒã€ç¾åœ¨AWS Amplifyã‚’VPCå†…ã«AWS Lambdaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚ŠIPã‚¢ãƒ‰ãƒ¬ã‚¹åˆ¶é™([#12](https://github.com/aws-amplify/amplify-hosting/issues/12))ã€WAFè¨­å®š([#36](https://github.com/aws-amplify/amplify-hosting/issues/36))ãªã©ã®è©³ç´°ãªè¨­å®šã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚ï¼ˆ[ä»Šæœˆä¸­ã«æ”¹å–„](https://github.com/aws-amplify/amplify-hosting/issues/36#issuecomment-2501313016)ã•ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼ï¼‰
æ¬¡ç« ã§ã¯ã€[aws-cdk](https://docs.aws.amazon.com/en_us/cdk/v2/guide/home.html)ã¨AWS Amplifyã®CI/CDã‚’ä½¿ç”¨ã—ã¦VPC Lambdaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€VPCå†…ã®RDSã‚„ä»–ã®AWSã‚¹ã‚¿ãƒƒã‚¯ãƒªã‚½ãƒ¼ã‚¹ã« Honoã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

https://github.com/aws-amplify/amplify-hosting/issues/794
https://aws.amazon.com/jp/blogs/mobile/accessing-resources-in-a-amazon-virtual-private-cloud-amazon-vpc-from-next-js-api-routes/

AWS Amplify Backendã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚µãƒ¼ãƒ“ã‚¹é–‹ç™ºã«å¿…è¦ãªæ§‹æˆã‚’ã™ãã«æ§‹ç¯‰ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚
ä¾‹ãˆã°ã€[AWS Cognito](https://docs.aws.amazon.com/cognito/latest/developerguide/what-is-amazon-cognito.html)ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚„[AWS DynamoDB](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Introduction.html)ã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚
æ¬¡ã®ã‚³ãƒžãƒ³ãƒ‰ã§AWS Amplify Backendã‚’åˆæœŸåŒ–ã—ã¾ã™ï¼š

> ```
> npm create amplify@latest
> ```

### 2.1. Define the Handler

ç°¡å˜ãª"Hello Hono!"ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™AWS Lambdaãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å®šç¾©ã—ã¾ã™ã€‚
ã“ã‚Œã¯ã€å°†æ¥çš„ã«VPCå†…ã®RDSã‚„EC2ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ä½¿ã‚ã‚Œã‚‹æƒ³å®šã§ã™ã€‚

> ```typescript
> // amplify/handler.mjs
> import { Hono } from "hono";
> import { handle } from "hono/aws-lambda";
> 
> const app = new Hono();
> 
> app.get("/", (c) => c.text("Hello Hono!"));
> 
> export const handler = handle(app);
> ```

### 2.2. Custom Lambda in VPC

AWS CDKã‚’ä½¿ç”¨ã—ã¦VPCå†…ã«AWS Lambdaã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ãƒƒã‚¯ã‚’å®šç¾©ã—ã¾ã™ã€‚
[Honoã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‰](https://hono.dev/docs/getting-started/aws-lambda#_3-deploy)ã‚’å‚è€ƒã«ã€aws-cdkã§VPC Lambdaã‚’æ§‹æˆã—ã¾ã™ã€‚

> ```typescript
> // amplify/custom.ts
> import * as cdk from "aws-cdk-lib";
> import * as lambda from "aws-cdk-lib/aws-lambda";
> import * as ec2 from "aws-cdk-lib/aws-ec2";
> import { Construct } from "constructs";
> import { NodejsFunction } from "aws-cdk-lib/aws-lambda-nodejs";
> 
> interface Props {
>   vpc: ec2.Vpc;
> }
> 
> export class VpcLambdaStack extends Construct {
>   constructor(scope: Construct, id: string, props: Props) {
>     super(scope, id);
> 
>     const { vpc } = props;
> 
>     const fn = new NodejsFunction(this, "VpcLambdaFunction", {
>       entry: "amplify/handler.mjs",
>       handler: "handler",
>       runtime: lambda.Runtime.NODEJS_18_X,
>       vpc,
>     });
> 
>     new cdk.CfnOutput(this, "VpcLambdaFunctionArn", {
>       value: fn.functionArn,
>       exportName: "VpcLambdaFunctionArn",
>     });
>   }
> }
> ```

### 2.3. Configure Backend

backend.tsã«VPC Lambdaã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€AWS Amplifyã®CI/CDã‚’é€šã˜ã¦æ§‹ç¯‰ãŠã‚ˆã³ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚ï¼ˆä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€Cognitoã¨Dynamodbã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ä¸€æ—¦å‰Šé™¤ã—ã¦ã„ã¾ã™ï¼‰

> ```typescript
> // amplify/backend.ts
> import { defineBackend } from "@aws-amplify/backend";
> import * as ec2 from "aws-cdk-lib/aws-ec2";
> import { auth } from "./auth/resource";
> import { data } from './data/resource';
> + import { VpcLambdaStack } from "./custom";
> 
> const backend = defineBackend({
> -   auth,
> -   data,
> });
> 
> const stack = backend.createStack("CustomResources");
> 
> const vpc = new ec2.Vpc(stack, "CustomStackVPC");
> 
> new VpcLambdaStack(stack, "CustomStackLambda", { vpc });
> ```

ã“ã‚Œã‚‰ã®å¤‰æ›´ã‚’GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã§ã€CI/CDä¸Šã§VPC Lambdaã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ ðŸš€

## 3. Accessing VPC Lambda via AWS Amplify

VPCå†…ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆSSRï¼‰ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€VPCå†…ã®Lambdaé–¢æ•°ã¨AWS Amplifyã‚’æŽ¥ç¶šã™ã‚‹æ‰‹é †ã‚’èª¬æ˜Žã—ã¾ã™ã€‚

### 3.1. Verify ARNs

æœ€åˆã«ã€AWS Amplifyã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨VPC Lambdaã®ä¸¡æ–¹ã®App ARNã‚’ãƒ¡ãƒ¢ã—ã¾ã™:

1. **AWS Amplify ARN**: `Amplify console > General settings` ãƒšãƒ¼ã‚¸ã«App ARNãŒã‚ã‚Šã¾ã™ã€‚å¾Œã§å‚ç…§ã™ã‚‹ã®ã§ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚‚ãƒ¡ãƒ¢ã—ã¾ã™ã€‚

> ![arn](https://r.tsei.jp/note/2024-12-10/arn.jpg)

2. **VPC Lambda ARN**: `CloudFormation > Stacks > {appname} > Outputs > value` ã«Amplifyã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚°ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚(å…ˆã»ã©ãƒ¡ãƒ¢ã—ãŸAmplify Appã®ARNã£ã½ã„CustomResourcesã«ã‚ã‚Šã¾ã™)

> ![output](https://r.tsei.jp/note/2024-12-10/output.jpg)

### 3.2. Attach IAM for Invoker

VPC Lambdaã‚’å‘¼ã³å‡ºã™ãŸã‚ã«IAM Userã‚’ä½œæˆã—ã¾ã™ã€‚
ã“ã®IAM Userã«ã¯VPC Lambdaã‚’invokeã™ã‚‹ã“ã¨ã‚’è¨±å¯ã™ã‚‹ãƒãƒªã‚·ãƒ¼ãŒå¿…è¦ã§ã™ã€‚

1. **Create IAM User**: VpcLambdaInvokerãªã©ã®ã„ã„ã‹ã‚“ã˜ã®åå‰ã§[IAM User ã‚’ä½œæˆ](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html)ã—ã€`IAM / Users / VpcLambdaInvoker / Create access key`ãƒšãƒ¼ã‚¸ã§[ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ãŠã‚ˆã³ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ï¼‰ã‚’ä½œæˆ](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html)ã—ã¾ã™ã€‚

> ![iam](https://r.tsei.jp/note/2024-12-10/iam.jpg)

2. **Policy Setup**: `IAM / Users / VpcLambdaInvoker / Create policy` ãƒšãƒ¼ã‚¸ã®JSONã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§IAM Userã«VPC Lambdaã‚’invokeã™ã‚‹æ¨©é™ã‚’ä»˜ä¸Žã™ã‚‹ãƒãƒªã‚·ãƒ¼ã‚’ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™ã€‚ãƒãƒªã‚·ãƒ¼ã«ã¯ä»¥å‰ãƒ¡ãƒ¢ã—ãŸVPC Lambdaã®App ARNã‚’ãƒªã‚½ãƒ¼ã‚¹ã®å€¤ã¨ã—ã¦æŒ‡å®šã—ã¾ã™ã€‚

> ```json
> {
>   "Version": "2012-10-17",
>   "Statement": [
>     {
>       "Effect": "Allow",
>       "Action": "lambda:InvokeFunction",
>       "Resource": "<VPC_Lambda_App_ARN>"
>     }
>   ]
> }
> ```

### 3.3. Attach AWS Hosting's Service Role

AWS AmplifyãŒä½¿ç”¨ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¦ã€VPC Lambdaã‚’å‘¼ã³å‡ºã™ãŸã‚ã®æ¨©é™ã‚’å«ã‚ã¾ã™:

1. **Role Selection**:`IAM / Roles`ãƒšãƒ¼ã‚¸ã§AmplifySSRLoggingRoleã‚’æ¤œç´¢ã—ã€ä»¥å‰ã«ãƒ¡ãƒ¢ã—ãŸAWS Amplifyã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã«ä¸€è‡´ã™ã‚‹ã‚‚ã®ã‚’é¸æŠžã—ã¾ã™ã€‚

> ![roles](https://r.tsei.jp/note/2024-12-10/roles.jpg)

2.  **Policy Configuration**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«å¿…è¦ãªSSMæ“ä½œã‚’è¨±å¯ã™ã‚‹ä»¥ä¸‹ã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¿ãƒƒãƒã—ã¾ã™ã€‚ä»¥å‰ã«ãƒ¡ãƒ¢ã—ãŸAWS Amplifyã®App ARNã®æœ€å¾Œã®ã»ã†ã«ã‚ã‚‹App IDã‚’AMPLIFY_APP_IDã«å…¥åŠ›ã—ã¾ã™ã€‚ï¼ˆãŸã¶ã‚“urlã¨ã‹ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹idã§ã™)

> ```json
> {
>   "Version": "2012-10-17",
>   "Statement": [
>     {
>       "Sid": "AllowAmplifySSMCalls",
>       "Effect": "Allow",
>       "Action": [
>         "ssm:GetParametersByPath",
>         "ssm:GetParameters",
>         "ssm:GetParameter"
>       ],
>       "Resource": [
>         "arn:aws:ssm:*:*:parameter/amplify/<AMPLIFY_APP_ID>/*"
>       ]
>     }
>   ]
> }
> ```

InvokeVpcLambdaPolicyã¿ãŸã„ãªåå‰ã‚’ä»˜ã‘ã¦ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ãŸã‚‰ã€IAMã®è¨­å®šã¯å®Œäº†ã§ã™ï¼
ä»¥ä¸‹ã®4ã¤ã®ç’°å¢ƒå¤‰æ•°ã®å€¤ã‚’ä¿å­˜ã—ã¦ãŠãã¾ã™ï¼š

> ```ruby
> # .env.local
> VPC_AWS_ACCESS_KEY_ID=xxxxxxxxxxxxxxxxxxxx
> VPC_AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
> VPC_LAMBDA_AWS_REGION=ap-northeast-1
> VPC_LAMBDA_FUNCTION_NAME=amplify-xxxxxxxxxxxxxx-xx-xxxxxxxxxxxxxxxxxxxxxxxx-xxxxxxxxxxxx
> ```

## 4. Create App

IAMã‚’è¨­å®šã—ãŸã®ã§ã€Wakuã®ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰VPCå†…ã®AWSãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
æœ€å¾Œã«ã€AWS AmplifyãŠã‚ˆã³Lambdaã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã€VPC Lambdaã‚’invokeã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜Žã—ã¾ã™ã€‚

### 4.1. Invoke VPC Lambda in Server Component

VPC Lambdaã‚’invokeã™ã‚‹ã“ã¨ã§ã€UIä¸Šã§VPCå†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯Server Componentã‹ã‚‰ VPC Lambdaã‚’å‘¼ã³å‡ºã™ä¾‹ã§ã™ï¼š

> ```typescript
> import { Lambda } from "@aws-sdk/client-lambda";
> 
> const lambda = new Lambda({
>   region: process.env.VPC_LAMBDA_AWS_REGION!,
>   credentials: {
>     accessKeyId: process.env.VPC_AWS_ACCESS_KEY_ID!,
>     secretAccessKey: process.env.VPC_AWS_SECRET_ACCESS_KEY!,
>   },
> });
> 
> async function invokeLambda() {
>   const args = {
>     FunctionName: process.env.VPC_LAMBDA_FUNCTION_NAME!,
>     Payload: JSON.stringify({}),
>   };
> 
>   const res = await lambda.invoke(args);
>   const buf = Buffer.from(res.Payload!);
>   return JSON.parse(buf.toString());
> }
> 
> export default async function HomePage() {
>   const data = await invokeLambda();
>   return <p>{data.body}</p>; // Display Hello Hono!
> }
> ```

### 4.2. Manage Environment Variables

å–å¾—ã—ãŸç’°å¢ƒå¤‰æ•°ã‚’Amplifyã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®`Manage environment variables`ãƒšãƒ¼ã‚¸ã§è¨­å®šã—ã¾ã™ã€‚

> ![env](https://r.tsei.jp/note/2024-12-10/env.jpg)

### 4.3. Deploy

CI/CDãƒ—ãƒ­ã‚»ã‚¹ä¸­ã«AWS Lambdaã«ç’°å¢ƒå¤‰æ•°ã‚’æ¸¡ã™ãŸã‚ã«amplify.ymlãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã™ã€‚
ä»¥ä¸Šã®æ‰‹é †ã§VPCå†…ã®AWSãƒªã‚½ãƒ¼ã‚¹ã«æŽ¥ç¶šã—ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸðŸŽ‰

> ```yml
> version: 1
> frontend:
>   phases:
>     preBuild:
>       commands:
>         - env | grep -e VPC_AWS_ACCESS_KEY_ID >> .env
>         - env | grep -e VPC_AWS_SECRET_ACCESS_KEY >> .env
>         - env | grep -e VPC_LAMBDA_AWS_REGION >> .env
>         - env | grep -e VPC_LAMBDA_FUNCTION_NAME >> .env
>         - npm ci --cache .npm --prefer-offline
>         - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
>     build:
>       commands:
>         - npm run build
>     postBuild:
>       commands:
>         - npm prune --production
>         - rm -rf ./.amplify-hosting
>         - mkdir -p ./.amplify-hosting/compute
>         - cp -r ./dist ./.amplify-hosting/compute/default
>         - cp -r ./node_modules ./.amplify-hosting/compute/default/node_modules
>         - cp -r ./dist/public ./.amplify-hosting/static
>         - cp -r ./dist/public ./.amplify-hosting/compute/default
>         - cp deploy-manifest.json ./.amplify-hosting/deploy-manifest.json
>         - cp startServer.mjs ./.amplify-hosting/compute/default/startServer.mjs
>         - 'echo "{ \"type\": \"module\" }" > ./.amplify-hosting/compute/default/package.json'
>   artifacts:
>     baseDirectory: .amplify-hosting
>     files:
>       - '**/*'
> ```

