---
title: "Hono ğŸ”¥ çˆ†å®‰SQLite CMS AWS deploy"
emoji: "ğŸ”¥"
type: "tech"
topics:
  - "aws"
  - "nextjs"
  - "lambda"
  - "amplify"
  - "hono"
published: true
published_at: "2024-12-15 22:05"
---

https://github.com/tseijp/next-amplify-with-lambda-test

![](https://r.tsei.jp/note/2024-12-15/demo.mp4.gif)

https://tsei.jp/articles/2024/12/15/note/

â†‘english ver

ã“ã®è¨˜äº‹ã¯ã€ã€Œ[AWS Amplifyã¨AWSÃ—ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ #AWSAmplifyJP Advent Calendar 2024](https://qiita.com/advent-calendar/2024/amplify)ã€15æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
ã“ã®è¨˜äº‹ã§ã¯ã€AWS Amplifyã‚’åˆ©ç”¨ã—ã¦AWSä¸Šã«ãŠæ‰‹è»½ã«CMSã®ãƒªã‚½ãƒ¼ã‚¹ã‚’SQLiteã¨Honoã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹å§‹ã—ã€ã“ã®è¨˜äº‹ã‚’å‚è€ƒã«ç°¡å˜ã«CMSã®æ§‹ç¯‰ã‚’è©¦ã›ã¾ã™ğŸš€

> ```ruby
> npx create-next-app@latest --yes
> cd my-app
> npm create amplify@latest --yes
> npm i hono sqlite3
> ```

## 1. AWSãƒªã‚½ãƒ¼ã‚¹ã«SQLiteã¨Honoã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

https://zenn.dev/nixieminton/articles/dc041d5bc8c09f

ã“ã®è¨˜äº‹ã‚’å‚è€ƒã«ã€CMSã«å¿…è¦ãªAWSãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã€Amplifyã‹ã‚‰æ§‹ç¯‰ã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚Amazon Elastic File Systemä¸Šã§SQLiteã‚’å‹•ã‹ã—ã€Lambdaã‹ã‚‰VPCå†…ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªHonoã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

### 1.1. VPCå†…ã®File Systemã¨Lambdaã‚’å®šç¾©ã™ã‚‹aws-cdkã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ

aws-cdkã‚’ä½¿ç”¨ã—ã¦AWSãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¾ã™ã€‚ã“ã‚Œã¯Amplifyã®CI/CDã‹ã‚‰è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚ä»¥ä¸‹ã®3ã¤ã®ãƒªã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ä¿å­˜ã—ã¾ã™ã€‚

https://github.com/tseijp/next-amplify-with-lambda-test/blob/main/amplify/custom/FileSystem/resource.ts

https://github.com/tseijp/next-amplify-with-lambda-test/blob/main/amplify/custom/VpcLambda/resource.ts

https://github.com/tseijp/next-amplify-with-lambda-test/blob/main/amplify/custom/VpcSubnet/resource.ts

### 1.2. backend.tsã«SQLiteã¨Honoã‚’å‹•ã‹ã™ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ 

ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦ã€CMSã«å¿…è¦ãªAWSãƒªã‚½ãƒ¼ã‚¹ãŒAmplifyã®CI/CDã‚’é€šã˜ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚å¾Œã€…èªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã€AWS Cognitoã‚‚ä¸€ç·’ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

> ```ts
> // amplify/backend.ts
> import { defineBackend } from "@aws-amplify/backend";
> import { auth } from "./auth/resource";
> import FileSystem from "./custom/FileSystem/resource";
> import VpcLambda from "./custom/VpcLambda/resource";
> import VpcSubnet from "./custom/VpcSubnet/resource";
> 
> const backend = defineBackend({ auth });
> 
> const stack = backend.createStack("CustomResources");
> 
> const { vpc } = new VpcSubnet(stack, "VpcSubnet");
> 
> const { accessPoint } = new FileSystem(stack, "FileSystem", { vpc });
> 
> new VpcLambda(stack, "VpcLambda", { vpc, accessPoint });
> ```

### 1.3. GitHubã®ãƒªãƒã‚¸ãƒˆãƒªã‚’Amplifyã®CI/CDã«æ¥ç¶šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤

handler.tsã‚’ä½œæˆã—ã€ä¸€æ—¦ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã‚‰ã®å¤‰æ›´ã‚’GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸå¾Œã€Amplifyã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ãƒãƒãƒãƒã™ã‚‹ã ã‘ã§è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚


> ```ts
> // handler.ts
> import sqlite3 from "sqlite3";
> 
> const DB_PATH = "/mnt/db/db.sqlite";
> 
> const db = new sqlite3.Database(DB_PATH);
> 
> export const handler = () => {
>   console.log(`Hello SQLite ${sqlite3.VERSION}`);
> };
> ```

## 2. Next.jsã‹ã‚‰VPCå†…ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹è¨­å®š

ã“ã®ç« ã§ã¯ã€Next.jsã‹ã‚‰VPCå†…ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«Amplifyã‚’æ¥ç¶šã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚Amplifyã¨IAMã®ãƒãƒªã‚·ãƒ¼ã¨ç’°å¢ƒå¤‰æ•°ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

### 2.1. Next.jsã‹ã‚‰VPCå†…ã®Lambdaã‚’å‘¼ã³å‡ºã™ãŸã‚ã®IAMã®è¨­å®š

https://zenn.dev/jp/articles/6a5f2d90d0c6c8#3.-accessing-vpc-lambda-via-aws-amplify

ä»Šé€±å…¬é–‹ã—ãŸã“ã®è¨˜äº‹ã®3ç« ã®æ‰‹é †ã¨åŒæ§˜ã«ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸAmplifyã¨Lambdaã®Arnã®æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã€Amplifyã¨IAMã®ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚ä»¥ä¸‹ã®4ã¤ã®ç’°å¢ƒå¤‰æ•°ã‚’å–å¾—ã—ã¾ã™ã€‚

> ```ruby
> # .env.local
> VPC_AWS_ACCESS_KEY_ID=xxxxxxxxxxxxxxxxxxxx
> VPC_AWS_SECRET_ACCESS_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
> VPC_LAMBDA_AWS_REGION=ap-northeast-1
> VPC_LAMBDA_FUNCTION_NAME=amplify-xxxxxxxxxxxxxx-xx-xxxxxxxxxxxxxxxxxxxxxxxx-xxxxxxxxxxxx
> ```

### 2.2. AWS Amplifyã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤

Amplifyã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã€ŒManage environment variablesã€ãƒšãƒ¼ã‚¸ã«ã€å–å¾—ã—ãŸ4ã¤ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚

> ![](https://r.tsei.jp/note/2024-12-15/env.jpg)

### 2.3. Lambdaã«ç’°å¢ƒè¨­å®šã‚’æ¸¡ã™ãŸã‚ã®amplify.ymlã‚’ä½œæˆ

ä»¥ä¸‹ã®amplify.ymlã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã«ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€4ã¤ã®ç’°å¢ƒå¤‰æ•°ã‚’ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã«æ¸¡ã™ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚

> ```yml
> # amplify.yml
> version: 1
> backend:
>   phases:
>     build:
>       commands:
>         - env | grep -e VPC_AWS_ACCESS_KEY_ID >> .env || true
>         - env | grep -e VPC_AWS_SECRET_ACCESS_KEY >> .env || true
>         - env | grep -e VPC_LAMBDA_AWS_REGION >> .env || true
>         - env | grep -e VPC_LAMBDA_FUNCTION_NAME >> .env || true
>         - npm ci --cache .npm --prefer-offline
>         - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
> frontend:
>   phases:
>     build:
>       commands:
>         - npm run build
>   artifacts:
>     baseDirectory: .next
>     files:
>       - '**/*'
>   cache:
>     paths:
>       - .next/cache/**/*
>       - .npm/**/*
> ```

## 3. Honoã®VPC Lambdaã§å‹•ãSQLite Handlerã®å®Ÿè£…

SQLiteã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®Honoã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã€Lambdaã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚TypeScriptã§APIã‚’é–‹ç™ºã™ã‚‹ã“ã¨ã§ã€APIå´ã®ä»•æ§˜ã‚’å‹æƒ…å ±ã¨ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®é–‹ç™ºå´ã«å…±æœ‰ã§ãã¾ã™ã€‚

### 3.1. SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã®ãŸã‚ã®handler.tsã®å®Ÿè£…ã‚³ãƒ¼ãƒ‰

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã‚„ãƒ‡ãƒ¼ã‚¿æ“ä½œã«å¿…è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’Honoã§é–‹ç™ºã—ã¾ã™ã€‚Honoã®Clientæ©Ÿèƒ½ã«ã‚ˆã‚Šã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«zodã‚’ä½¿ç”¨ã—ã¦POSTæ™‚ã«å‹ãƒ’ãƒ³ãƒˆã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

> ```ts
> // handler.ts
> 
> // ...
> 
> export const app = new Hono();
> 
> export const db = new sqlite3.Database(DB_PATH);
> 
> export const routes = app
>   .get("/init", async (c) => {
>     await run(tableCreationQuery);
>     return c.json({ message: "inited" });
>   })
>   .get("/", async (c) => {
>     const page = parseInt(c.req.query("page") || "1");
>     const q = `SELECT * FROM items ORDER BY created_at DESC LIMIT ? OFFSET ?`;
>     const res = await all<Item[]>(q, 10, 10 * (page - 1));
>     return c.json(res);
>   })
>   .post("/", zValidator("json", createSchema), async (c) => {
>     const { title, content } = c.req.valid("json");
>     const q = `INSERT INTO items (title, content) VALUES (?, ?)`;
>     const id = await run(q, title, content);
>     return c.json({ id }, 201);
>   })
> 
> // ...
> 
> export type AppType = typeof routes;
> 
> export const handler = handle(app);
> ```

### 3.2. ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«SQLiteãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

Honoã®testClientã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚µãƒ¼ãƒãƒ¼ã¨ãƒ†ã‚¹ãƒˆé–“ã§TypeScriptã®å‹ãŒå…±æœ‰ã•ã‚Œã€ãƒ†ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ‡ã‚£ã‚¿è£œå®ŒãŒå‹•ãã¾ã™ã€‚APIå´ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å¤‰æ›´ã™ã‚‹ã¨TypeErrorã‚’æ¤œå‡ºã—ã€ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®è£œå®Œã«ã‚ˆã£ã¦ä¿®æ­£ã§ãã¾ã™ã€‚

> ![](https://r.tsei.jp/note/2024-12-15/unit.mov.gif)

### 3.3. SQLiteãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’AWS Consoleã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦æ©Ÿèƒ½æ¤œè¨¼

GitHubã«å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ãã®å¾Œã€AWSã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰Lambdaã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚`/init` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã‹ã‚‰ã€ä»–ã®æ“ä½œã‚’å‹•ä½œç¢ºèªã—ã¾ã™ã€‚

> ![](https://r.tsei.jp/note/2024-12-15/lambda.gif)

## 4. Next.jsã®Server Componentã§å‹•ãLambda Invokerã®å®Ÿè£…

Next.jså´ã‹ã‚‰Lambdaã‚’å‘¼ã³å‡ºã—ã¦VPCå†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚Honoã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ©Ÿèƒ½ã¨å‹å®šç¾©ã‚’åˆ©ç”¨ã—ãŸé–‹ç™ºã®å®¹æ˜“ã•ã‚‚è©±ã—ã¾ã™ã€‚

### 4.1. VPCå†…ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹Lambda invoker.tsã®å®Ÿè£…ã‚³ãƒ¼ãƒ‰

ä¿å­˜ã—ãŸç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦Lambdaã‚’å‘¼ã³å‡ºã™é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚Honoã®Clientæ©Ÿèƒ½ã¨ä¸€ç·’ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€APIå´ã®å‹æƒ…å ±ã‚’å†ã³å…±æœ‰ã§ãã¾ã™ã€‚

> ```ts
> // invoker.ts
> import { AppType } from "@/handler";
> import { Lambda } from "@aws-sdk/client-lambda";
> import { hc } from "hono/client";
> 
> const lambda = new Lambda({
>   region: process.env.VPC_LAMBDA_AWS_REGION!,
>   credentials: {
>     accessKeyId: process.env.VPC_AWS_ACCESS_KEY_ID!,
>     secretAccessKey: process.env.VPC_AWS_SECRET_ACCESS_KEY!,
>   },
> });
> 
> const customFetch = async (path: RequestInfo | URL, init?: RequestInit) => {
>   const { body, method, headers } = init ?? {};
>   const payload = {
>     path,
>     body,
>     httpMethod: method,
>     headers: Object.fromEntries(headers as []),
>     isBase64Encoded: false,
>   };
> 
>   const args = {
>     FunctionName: process.env.VPC_LAMBDA_FUNCTION_NAME,
>     Payload: JSON.stringify(payload),
>   };
> 
>   const res = await lambda.invoke(args);
>   const buf = Buffer.from(res.Payload!);
>   const obj = JSON.parse(buf.toString());
>   return new Response(obj.body);
> };
> 
> export const invoker = () => hc<AppType>("", { fetch: customFetch });
> ```

### 4.2. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¨åŒã˜ã‚³ãƒ¼ãƒ‰ã§Lambda invokeã®çµ±åˆãƒ†ã‚¹ãƒˆ

ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®testClientéƒ¨åˆ†ã‚’invokerã«å¤‰ãˆã‚‹ã“ã¨ã§ã€å…¨ãåŒã˜ã‚³ãƒ¼ãƒ‰ã§çµ±åˆãƒ†ã‚¹ãƒˆã«å¤‰ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

> ![](https://r.tsei.jp/note/2024-12-15/e2e.mov.gif)

### 4.3. Next.jsã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰VPCå†…ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æ“ä½œ

Next.jsã®Server Componentå´ã‹ã‚‰Lambdaã‚’invokeã—ã¦ã¿ã¦ã€VPCå†…ã®SQLiteã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ãˆã‚‹ã‹ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã¾ã™ã€‚ã‚ã¨ã¯é ‘å¼µã£ã¦CURDã®æ©Ÿèƒ½ã‚’UIä¸Šã§å®Ÿè£…ã™ã‚Œã°å†’é ­ã®CMSã®å®Œæˆã§ã™ï¼

```ts
// app/page.tsx
export default async function Home() {
  const res = await app.index.$get();
  const list = await res.json();
  return JSON.stringify(list);
}
```
